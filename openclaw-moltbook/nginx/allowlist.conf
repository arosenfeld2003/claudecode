# OpenClaw Moltbook Monitor - Domain Allowlist
# Only these domains are accessible through the reverse proxy
# Any request to other domains will be blocked with 403

# Moltbook Platform (primary monitoring target)
location ~ ^/proxy/www\.moltbook\.com(/.*)?$ {
    limit_req zone=moltbook_limit burst=20 nodelay;

    # Rewrite path to remove /proxy/www.moltbook.com prefix
    rewrite ^/proxy/www\.moltbook\.com(/.*)?$ $1 break;

    proxy_pass https://www.moltbook.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

    proxy_set_header Host www.moltbook.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header User-Agent $http_user_agent;

    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Pass through rate limit headers from Moltbook API
    proxy_pass_header X-RateLimit-Limit;
    proxy_pass_header X-RateLimit-Remaining;
    proxy_pass_header X-RateLimit-Reset;

    # Handle proxy errors gracefully
    proxy_intercept_errors on;
    error_page 502 503 504 = @proxy_error;
}

# Moltbook API (primary monitoring target)
location ~ ^/proxy/api\.moltbook\.com(/.*)?$ {
    limit_req zone=moltbook_limit burst=20 nodelay;

    rewrite ^/proxy/api\.moltbook\.com(/.*)?$ $1 break;

    proxy_pass https://api.moltbook.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

    proxy_set_header Host api.moltbook.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header User-Agent $http_user_agent;

    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    proxy_pass_header X-RateLimit-Limit;
    proxy_pass_header X-RateLimit-Remaining;
    proxy_pass_header X-RateLimit-Reset;

    proxy_intercept_errors on;
    error_page 502 503 504 = @proxy_error;
}

# GitHub (for robots.txt and reference documentation)
location ~ ^/proxy/github\.com(/.*)?$ {
    limit_req zone=moltbook_limit burst=10 nodelay;

    rewrite ^/proxy/github\.com(/.*)?$ $1 break;

    proxy_pass https://github.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

    proxy_set_header Host github.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header User-Agent $http_user_agent;

    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    proxy_intercept_errors on;
    error_page 502 503 504 = @proxy_error;
}

# GitHub Raw Content (for fetching raw files)
location ~ ^/proxy/raw\.githubusercontent\.com(/.*)?$ {
    limit_req zone=moltbook_limit burst=10 nodelay;

    rewrite ^/proxy/raw\.githubusercontent\.com(/.*)?$ $1 break;

    proxy_pass https://raw.githubusercontent.com;
    proxy_ssl_server_name on;
    proxy_ssl_verify on;
    proxy_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

    proxy_set_header Host raw.githubusercontent.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header User-Agent $http_user_agent;

    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    proxy_intercept_errors on;
    error_page 502 503 504 = @proxy_error;
}

# Proxy error handler - returns JSON error response
location @proxy_error {
    return 503 '{"error":"proxy_error","message":"Upstream server unavailable","timestamp":"$time_iso8601"}';
    add_header Content-Type application/json;
}
