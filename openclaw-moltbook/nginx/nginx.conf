# OpenClaw Moltbook Monitor - Nginx Reverse Proxy Configuration
# Purpose: Route all outbound traffic through allowlisted domains only
# Security: Only www.moltbook.com, api.moltbook.com, github.com, raw.githubusercontent.com allowed

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # JSON log format for audit trail
    log_format json_audit escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"client":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$request_uri",'
        '"host":"$http_host",'
        '"status":$status,'
        '"bytes_sent":$bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_status":"$upstream_status",'
        '"upstream_response_time":"$upstream_response_time",'
        '"user_agent":"$http_user_agent"'
    '}';

    access_log /var/log/nginx/access.log json_audit;

    # Rate limiting: 100 requests per minute per client (backup to client-side limiting)
    limit_req_zone $binary_remote_addr zone=moltbook_limit:10m rate=100r/m;
    limit_req_status 429;

    # Upstream servers (proxy targets)
    upstream moltbook_www {
        server www.moltbook.com:443;
        keepalive 32;
    }

    upstream moltbook_api {
        server api.moltbook.com:443;
        keepalive 32;
    }

    upstream github {
        server github.com:443;
        keepalive 16;
    }

    upstream github_raw {
        server raw.githubusercontent.com:443;
        keepalive 16;
    }

    # Main proxy server
    server {
        listen 8080;
        server_name localhost;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 '{"status":"healthy","timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }

        # Proxy status endpoint
        location /proxy-status {
            access_log off;
            stub_status on;
            allow 172.16.0.0/12;  # Docker internal networks
            allow 10.0.0.0/8;
            allow 192.168.0.0/16;
            deny all;
        }

        # Include domain allowlist configuration
        include /etc/nginx/allowlist.conf;

        # Default: deny all other requests
        location / {
            return 403 '{"error":"domain_not_allowed","message":"Request blocked: domain not in allowlist","timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }
    }
}
